<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="毕业后就一直混迹在深圳的不知名攻城狮"><meta name="baidu-site-verification" content="code-osvb6rgMcu"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>ShardingSphere学习 | sunshine-zwq</title><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ShardingSphere学习</h1><a id="logo" href="/.">sunshine-zwq</a><p class="description">Where there is a will, there is a way.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">ShardingSphere学习</h1><div class="post-meta"><a href="/2021/03/04/ShardingSphere%E5%AD%A6%E4%B9%A0/#comments" class="comment-count"></a><p><span class="date">2021/03/04</span><span><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category">数据库</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="1-基本概念"><a href="#1-基本概念" class="headerlink" title="1.基本概念"></a>1.基本概念</h2><h3 id="1-1-什么是-Sharding-Sphere"><a href="#1-1-什么是-Sharding-Sphere" class="headerlink" title="1.1 什么是 Sharding Sphere"></a>1.1 什么是 Sharding Sphere</h3><p>Apache ShardingSphere 是一套开源的分布式数据库中间件解决方案组成的生态圈，它由 <strong>Sharding-JDBC</strong>、<strong>Sharding-Proxy</strong> 和 <strong>Sharding-Sidecar</strong>（规划中）这 3 款相互独立，却又能够混合部署配合使用的产品组成。它们均提供标准化的数据分片、分布式事务和数据库治理功能，可适用于如 Java 同构、异构语言、云原生等各种多样化的应用场景。</p>
<p><strong>ShardingSphere 定位为关系型数据库中间件，旨在充分合理地在分布式的场景下利用关系型数据库的计算和存储能力，而并非实现一个全新的关系型数据库。</strong></p>
<h3 id="1-2-什么是分库分表"><a href="#1-2-什么是分库分表" class="headerlink" title="1.2 什么是分库分表"></a>1.2 什么是分库分表</h3><p>数据库中的数据量不一定是可控的，在未进行分库分表的情况下，随着时间和业务的发展，库中的表会越来越多，表中的数据量也会越来越大，相应地，数据操作，增删改查的开销也会越来越大；另外，由于无法进行分布式式部署，而一台服务器的资源（CPU、磁盘、内存、IO 等）是有限的，最终数据库所能承载的数据量、数据处理能力都将遭遇瓶颈。</p>
<p>分库分表就是为了解决由于数据量过大而导致数据库性能降低的问题，将原来独立的数据库拆分成若干数据库组成，将数据大表拆分成若干数据表组成，使得单一数据库、单一数据表的数据量变小，从而达到提升数据库性能的目的。</p>
<h4 id="1-2-1-分库分表的方式"><a href="#1-2-1-分库分表的方式" class="headerlink" title="1.2.1 分库分表的方式"></a>1.2.1 分库分表的方式</h4><p>数据库的切分指的是通过某种特定的条件，将我们存放在同一个数据库中的数据分散存放到多个数据库（主机）中，以达到分散单台设备负载的效果，即分库分表。</p>
<p>数据的切分根据其切分规则的类型，可以分为 垂直切分 和 水平切分。</p>
<p>（1）垂直切分：把单一的表拆分成多个表，并分散到不同的数据库（主机）上。<br>（2）水平切分：根据表中数据的逻辑关系，将表中的数据按照某种条件拆分到多台数据库上。</p>
<h4 id="1-2-2-垂直切分"><a href="#1-2-2-垂直切分" class="headerlink" title="1.2.2 垂直切分"></a>1.2.2 垂直切分</h4><p>一个数据库有多个表构成，每个表对应不同的业务，垂直切分是只按照业务将表进行分类，将其分布到不同的数据库上，这样就将数据分担到了不同的库上（<strong>专库专用</strong>）。</p>
<p>例如：</p>
<blockquote>
<p>有如下几张表：<br>•  用户信息表（User）<br>•  课程信息表（Courses）<br>•  订单信息表（Orders）<br>•  针对以上案例，垂直切分就是根据每个表的不同业务进行切分。<br>•  比如 User 表，Courses 表和 Orders 表，将每个表切分到不同的数据库上。</p>
<p>垂直分库：</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/001.png" alt=""></p>
<p>垂直分表：</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/002.png" alt=""></p>
</blockquote>
<p>垂直切分的优点如下：<br>（1）拆分后业务清晰，系统之间进行整合或扩展很容易。<br>（2）按照成本、应用的等级、应用的类型等将表放到不同的机器上，便于管理，数据维护简单。</p>
<p>垂直切分的缺点如下：<br>（1）部分业务表无法关联(Join)，只能通过接口方式解决，提高了系统的复杂度。<br>（2）受每种业务的不同限制，存在单库性能瓶颈，不易进行数据扩展和提升性能。<br>（3）事务处理变得复杂。</p>
<h4 id="1-2-3-水平切分"><a href="#1-2-3-水平切分" class="headerlink" title="1.2.3 水平切分"></a>1.2.3 水平切分</h4><p>与垂直切分对比，水平切分不是将表进行分类，而是将其按照某个字段的某种规则分散到多个库中，在每个表中包含一部分数据，所有表加起来就是全量的数据。</p>
<p>简单来说，<strong>我们可以将对数据的水平切分理解为按照数据行进行切分，就是将表中的某些行切分到一个数据库表中，而将其他行切分到其他数据库表中</strong>。</p>
<p>这种切分方式根据单表的数据量的规模来切分，保证单表的容量不会太大，从而保证了单表的查询等处理能力。例如将用户的信息表拆分成 User1、User2 等，表结构是完全一样的。我们通常根据某些特定的规则来划分表，比如根据用户的 ID 来取模划分。</p>
<p>举例：</p>
<blockquote>
<p>在博客类系统中，读取量一般都会很大。当同时有 100 万个用户在浏览时，如果是单表，则单表会进行 100 万次请求，如果是单库，数据库就会承受 100 万次的请求压力。如果采取水平切分来减少每个单表的压力，将其分为 100 个表，并且分布在 10 个数据库中，每个表进行 1 万次请求，则每个数据库会承受 10 万次的请求压力，虽然这不可能绝对平均，但是这样，压力就减少了很多，并且是成倍减少的。</p>
<p>水平分库：</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/003.png" alt=""></p>
<p>水平分表：</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/004.png" alt=""></p>
</blockquote>
<p>水平切分的优点：<br>（1）单库单表的数据保持在一定的量级，有助于性能的提高。<br>（2）切分的表的结构相同，应用层改造较少，只需要增加路由规则即可。<br>（3）提高了系统的稳定性和负载能力。</p>
<p>水平切分的缺点如下：<br>（1）切分后，数据是分散的，很难利用数据库的 Join 操作，跨库 Join 性能较差。<br>（2）分片事务的一致性难以解决，数据扩容的难度和维护量极大。</p>
<h4 id="1-2-4-分库分表应用及问题"><a href="#1-2-4-分库分表应用及问题" class="headerlink" title="1.2.4 分库分表应用及问题"></a>1.2.4 分库分表应用及问题</h4><p>（一）应用</p>
<p>（1）在数据库设计时候考虑垂直分库和垂直分表<br>（2）随着数据库数据量增加，不要马上考虑做水平切分，首先考虑缓存处理，读写分离，使用索引等等方式，如果这些方式不能根本解决问题了，再考虑做水平分库和水平分表</p>
<p>（二）分库分表问题</p>
<p>综上所述，垂直切分和水平切分的共同点如下：<br>•  存在跨节点 Join 的问题。<br>•  存在跨节点合并排序、分页的问题。<br>•  存在多数据源管理的问题。</p>
<h2 id="2-Sharding-JDBC"><a href="#2-Sharding-JDBC" class="headerlink" title="2.Sharding-JDBC"></a>2.Sharding-JDBC</h2><h3 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>Sharding-JDBC 是 ShardingSphere 的第一个产品，也是 ShardingSphere 的前身。 它<strong>定位为轻量级 Java 框架，在 Java 的 JDBC 层提供的额外服务</strong>。它使用客户端直连数据库，以 jar 包形式提供服务，无需额外部署和依赖，<strong>可理解为增强版的 JDBC 驱动</strong>，完全兼容JDBC 和各种 ORM 框架。</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/005.png" alt=""></p>
<p>Sharding-JDBC 的核心功能为<strong>数据分片</strong>和<strong>读写分离</strong>，通过 Sharding-JDBC，应用可以透明的使用 jdbc 访问已经分库分表、读写分离的多个数据源，而不用关心数据源的数量以及数据如何分布。</p>
<ul>
<li>适用于任何基于 JDBC 的 ORM 框架，如：JPA, Hibernate, Mybatis, Spring JDBC Template 或直接使用 JDBC。</li>
<li>支持任何第三方的数据库连接池，如：DBCP, C3P0, BoneCP, Druid, HikariCP 等。</li>
<li>支持任意实现 JDBC 规范的数据库。目前支持 MySQL，Oracle，SQLServer，PostgreSQL 以及任何遵循 SQL92 标准的数据库。</li>
</ul>
<p><strong>Sharding-JDBC支持以下几种分片策略：</strong></p>
<blockquote>
<p>不管理分库还是分表，策略基本一样。</p>
<p><strong>standard：标准分片策略</strong>，对应 StandardShardingStrategy。提供对 SQL 语句中的 =, IN 和 BETWEEN AND 的分片操作支持。StandardShardingStrategy 只支持单分片键，提供 PreciseShardingAlgorithm 和 RangeShardingAlgorithm 两个分片算法。PreciseShardingAlgorithm 是必选的，用于处理 = 和 IN 的分片。RangeShardingAlgorithm 是可选的，用于处理 BETWEEN AND 分片，如果不配置 RangeShardingAlgorithm，SQL 中的 BETWEEN AND 将按照全库路由处理。</p>
<p><strong>complex：复合分片策略</strong>，对应 ComplexShardingStrategy。复合分片策略提供对SQL语句中的 =, IN 和 BETWEEN AND 的分片操作支持。ComplexShardingStrategy 支持多分片键，由于多分片键之间的关系复杂，因此并未进行过多的封装，而是直接将分片键值组合以及分片操作符透传至分片算法，完全由应用开发者实现，提供最大的灵活度。</p>
<p><strong>inline：行表达式分片策略</strong>，对应 InlineShardingStrategy。使用 Groovy 的表达式，提供对 SQL 语句中的 = 和 IN 的分片操作支持，只支持单分片键。对于简单的分片算法，可以通过简单的配置使用，从而避免繁琐的 Java 代码开发，如:  t_user_$-&gt;{u_id % 8}  表示 t_user 表根据 u_id 模 8，而分成 8 张表，表名称为 t_user_0  到 t_user_7。</p>
<p><strong>hint：Hint分片策略</strong>，对应 HintShardingStrategy。通过 Hint 而非 SQL 解析的方式分片的策略。对于分片字段非 SQL 决定，而由其他外置条件决定的场景，可使用 SQL Hint 灵活的注入分片字段。例：内部系统，按照员工登录主键分库，而数据库中并无此字段。SQL Hint 支持通过 Java API 和 SQL 注释(待实现)两种方式使用。</p>
<p><strong>none：不分片策略</strong>，对应 NoneShardingStrategy。不分片的策略。</p>
</blockquote>
<h3 id="2-2-实现水平分表"><a href="#2-2-实现水平分表" class="headerlink" title="2.2 实现水平分表"></a>2.2 实现水平分表</h3><ul>
<li><p>搭建环境</p>
<p>（1）技术：SpringBoot 2.2.1+ MyBatisPlus + Sharding-JDBC + Druid 连接池<br>（2）创建 SpringBoot 工程</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/006.png" alt=""></p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/007.png" alt=""></p>
<p>（3）修改工程 SpringBoot 版本 2.2.1</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/008.png" alt=""></p>
<p>（4）引入需要的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0-RC1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>按照水平分表的方式，创建数据库和数据库表</p>
<p>（1）创建数据库 course_db<br>（2）在数据库创建两张表 course_1 和 course_2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> course_1(</span><br><span class="line">	cid <span class="built_in">BIGINT</span>(<span class="number">20</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">	cname <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	user_id <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	cstatus <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> course_2(</span><br><span class="line">	cid <span class="built_in">BIGINT</span>(<span class="number">20</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">	cname <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	user_id <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	cstatus <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>（3）约定规则：如果添加课程 id 是偶数把数据添加 course_1，如果奇数添加到 course_2</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/009.png" alt=""></p>
</li>
<li><p>编写代码实现对分库分表后数据的操作</p>
<p>（1）创建实体类、mapper</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/010.png" alt=""></p>
<p>实体类 Course.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Course</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long cid;</span><br><span class="line">    <span class="keyword">private</span> String cname;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String cstatus;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CourseMapper.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CourseMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Course</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）程序主入口增加<code>@MapperScan</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.zwq.shardingjdbc.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingjdbcApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ShardingjdbcApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 Sharding-JDBC 分片策略</p>
<p>（1）在项目 application.properties 配置文件中进行配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sharding-jdbc 分片策略</span></span><br><span class="line"><span class="comment"># 配置数据源，给数据源起名</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.names</span>=<span class="string">m1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.url</span>=<span class="string">jdbc:mysql://localhost:3306/course_db?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定course分布情况，配置 表在哪个数据库里面，表名称是什么 m1:course_1,m1:course_2</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.actual-data-nodes</span>=<span class="string">m1.course_$-&gt;&#123;1..2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定course表的主键cid生成策略 SNOWFLAKE</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定分片策略 约定cid值偶数添加到course_1表，如果cid是奇数添加到course_2表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.sharding-column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.algorithm-expression</span>=<span class="string">course_$-&gt;&#123;cid % 2 + 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开sql输出日志</span></span><br><span class="line"><span class="meta">spring.shardingsphere.props.sql.show</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShardingjdbcApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注入mapper</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CourseMapper courseMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加课程的方法</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCourse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">            Course course = <span class="keyword">new</span> Course();</span><br><span class="line">            course.setCname(<span class="string">"java"</span> + i);</span><br><span class="line">            course.setUserId(<span class="number">100L</span>);</span><br><span class="line">            course.setCstatus(<span class="string">"Normal"</span> + i);</span><br><span class="line">            courseMapper.insert(course);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询课程的方法</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findCourse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;Course&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(<span class="string">"cid"</span>, <span class="number">573560191916703745L</span>);</span><br><span class="line">        Course course = courseMapper.selectOne(wrapper);</span><br><span class="line">        System.out.println(course);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试问题：上面测试代码执行，会有以下报错：</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/011.png" alt=""></p>
<p>解决方案：在配置文件 application.properties 中添加一行配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一个实体类对应两张表，覆盖</span></span><br><span class="line"><span class="meta">spring.main.allow-bean-definition-overriding</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="2-3-实现水平分库"><a href="#2-3-实现水平分库" class="headerlink" title="2.3 实现水平分库"></a>2.3 实现水平分库</h3><ul>
<li><p>需求分析</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/012.png" alt=""></p>
</li>
<li><p>创建数据库和表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> course_1(</span><br><span class="line">	cid <span class="built_in">BIGINT</span>(<span class="number">20</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">	cname <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	user_id <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	cstatus <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> course_2(</span><br><span class="line">	cid <span class="built_in">BIGINT</span>(<span class="number">20</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">	cname <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	user_id <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	cstatus <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/013.png" alt=""></p>
</li>
<li><p>在 SpringBoot 配置文件配置数据库分片规则</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sharding-jdbc 分片策略</span></span><br><span class="line"><span class="comment"># 配置数据源，给数据源起名</span></span><br><span class="line"><span class="comment"># 水平分库，配置2个数据源</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.names</span>=<span class="string">m1,m2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m1具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.url</span>=<span class="string">jdbc:mysql://localhost:3306/edu_db_1?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m2具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.url</span>=<span class="string">jdbc:mysql://localhost:3306/edu_db_2?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库分布情况、数据库里面表分布情况</span></span><br><span class="line"><span class="comment"># m1、m2  course_1、course_2</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.actual-data-nodes</span>=<span class="string">m$-&gt;&#123;1..2&#125;.course_$-&gt;&#123;1..2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定course表的主键cid生成策略 SNOWFLAKE</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定表分片策略 约定cid值偶数添加到course_1表，如果cid是奇数添加到course_2表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.sharding-column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.algorithm-expression</span>=<span class="string">course_$-&gt;&#123;cid % 2 + 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库分片策略 约定 user_id 是偶数添加到 m1，是奇数添加到 m2</span></span><br><span class="line"><span class="comment">#spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column=user_id</span></span><br><span class="line"><span class="comment">#spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression=m$-&gt;&#123;user_id % 2 + 1&#125;</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.database-strategy.inline.sharding-column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.database-strategy.inline.algorithm-expression</span>=<span class="string">m$-&gt;&#123;user_id % 2 + 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开sql输出日志</span></span><br><span class="line"><span class="meta">spring.shardingsphere.props.sql.show</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个实体类对应两张表，覆盖</span></span><br><span class="line"><span class="meta">spring.main.allow-bean-definition-overriding</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加操作</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCourseDb</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Course course = <span class="keyword">new</span> Course();</span><br><span class="line">       course.setCname(<span class="string">"javademo1"</span>);</span><br><span class="line">       <span class="comment">// 分库根据 user_id</span></span><br><span class="line">       course.setUserId(<span class="number">100L</span>);</span><br><span class="line">       course.setCstatus(<span class="string">"Normal1"</span>);</span><br><span class="line">       courseMapper.insert(course);</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 查询操作</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findCourseDb</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       QueryWrapper&lt;Course&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">       <span class="comment">// 设置 userid 值</span></span><br><span class="line">       wrapper.eq(<span class="string">"user_id"</span>,<span class="number">100L</span>);</span><br><span class="line">       <span class="comment">// 设置 cid 值</span></span><br><span class="line">       wrapper.eq(<span class="string">"cid"</span>,<span class="number">573805100078727169L</span>);</span><br><span class="line">       Course course = courseMapper.selectOne(wrapper);</span><br><span class="line">       System.out.println(course);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="2-4-实现垂直分库"><a href="#2-4-实现垂直分库" class="headerlink" title="2.4 实现垂直分库"></a>2.4 实现垂直分库</h3><ul>
<li><p>需求分析</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/014.png" alt=""></p>
</li>
<li><p>创建数据库和表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_user(</span><br><span class="line">	user_id <span class="built_in">BIGINT</span>(<span class="number">20</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">	username <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	ustatus <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/015.png" alt=""></p>
</li>
<li><p>创建 User 实体类和 mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(value = <span class="string">"t_user"</span>) <span class="comment">// 指定对应表名</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String ustatus;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置垂直分库策略</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sharding-jdbc 分片策略</span></span><br><span class="line"><span class="comment"># 配置数据源，给数据源起名</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.names</span>=<span class="string">m1,m2,m0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m1具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.url</span>=<span class="string">jdbc:mysql://localhost:3306/edu_db_1?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m2具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.url</span>=<span class="string">jdbc:mysql://localhost:3306/edu_db_2?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m0具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.url</span>=<span class="string">jdbc:mysql://localhost:3306/user_db?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置user_db数据库里面t_user专库专表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.actual-data-nodes</span>=<span class="string">m$-&gt;&#123;0&#125;.t_user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的主键cid生成策略 SNOWFLAKE</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.key-generator.column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># t_user表不分片</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.table-strategy.inline.sharding-column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.table-strategy.inline.algorithm-expression</span>=<span class="string">t_user</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库分布情况、数据库里面表分布情况</span></span><br><span class="line"><span class="comment"># m1、m2  course_1、course_2</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.actual-data-nodes</span>=<span class="string">m$-&gt;&#123;1..2&#125;.course_$-&gt;&#123;1..2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定course表的主键cid生成策略 SNOWFLAKE</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定表分片策略 约定cid值偶数添加到course_1表，如果cid是奇数添加到course_2表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.sharding-column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.algorithm-expression</span>=<span class="string">course_$-&gt;&#123;cid % 2 + 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库分片策略 约定 user_id 是偶数添加到 m1，是奇数添加到 m2</span></span><br><span class="line"><span class="comment">#spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column=user_id</span></span><br><span class="line"><span class="comment">#spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression=m$-&gt;&#123;user_id % 2 + 1&#125;</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.database-strategy.inline.sharding-column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.database-strategy.inline.algorithm-expression</span>=<span class="string">m$-&gt;&#123;user_id % 2 + 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开sql输出日志</span></span><br><span class="line"><span class="meta">spring.shardingsphere.props.sql.show</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个实体类对应两张表，覆盖</span></span><br><span class="line"><span class="meta">spring.main.allow-bean-definition-overriding</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入 user 的 mapper</span></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 添加操作</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUserDb</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       User user = <span class="keyword">new</span> User();</span><br><span class="line">       user.setUsername(<span class="string">"lucy"</span>);</span><br><span class="line">       user.setUstatus(<span class="string">"a"</span>);</span><br><span class="line">       userMapper.insert(user);</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 查询操作</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUserDb</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">       <span class="comment">// 设置 userid 值</span></span><br><span class="line">       wrapper.eq(<span class="string">"user_id"</span>,<span class="number">573824896195362817L</span>);</span><br><span class="line">       User user = userMapper.selectOne(wrapper);</span><br><span class="line">       System.out.println(user);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="2-5-操作公共表"><a href="#2-5-操作公共表" class="headerlink" title="2.5 操作公共表"></a>2.5 操作公共表</h3><ul>
<li><p>公共表-简介</p>
<p>公共表属于系统中数据量较小，变动少，而且属于高频联合查询的依赖表。参数表、数据字典表等属于此类型。可以将这类表在每个数据库都保存一份，所有更新操作都同时发送到所有分库执行。</p>
</li>
<li><p>在多个数据库都创建相同结构公共表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_udict(</span><br><span class="line">	dictid <span class="built_in">BIGINT</span>(<span class="number">20</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">	ustatus <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	uvalue <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/016.png" alt=""></p>
</li>
<li><p>在项目配置文件 application.properties 进行公共表配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sharding-jdbc 分片策略</span></span><br><span class="line"><span class="comment"># 配置数据源，给数据源起名</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.names</span>=<span class="string">m1,m2,m0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m1具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.url</span>=<span class="string">jdbc:mysql://localhost:3306/edu_db_1?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m2具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.url</span>=<span class="string">jdbc:mysql://localhost:3306/edu_db_2?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m0具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.url</span>=<span class="string">jdbc:mysql://localhost:3306/user_db?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置公共表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.broadcast-tables</span>=<span class="string">t_udict</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_udict.key-generator.column</span>=<span class="string">dictid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_udict.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置user_db数据库里面t_user专库专表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.actual-data-nodes</span>=<span class="string">m$-&gt;&#123;0&#125;.t_user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的主键cid生成策略 SNOWFLAKE</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.key-generator.column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># t_user表不分片</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.table-strategy.inline.sharding-column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.table-strategy.inline.algorithm-expression</span>=<span class="string">t_user</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库分布情况、数据库里面表分布情况</span></span><br><span class="line"><span class="comment"># m1、m2  course_1、course_2</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.actual-data-nodes</span>=<span class="string">m$-&gt;&#123;1..2&#125;.course_$-&gt;&#123;1..2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定course表的主键cid生成策略 SNOWFLAKE</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定表分片策略 约定cid值偶数添加到course_1表，如果cid是奇数添加到course_2表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.sharding-column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.algorithm-expression</span>=<span class="string">course_$-&gt;&#123;cid % 2 + 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库分片策略 约定 user_id 是偶数添加到 m1，是奇数添加到 m2</span></span><br><span class="line"><span class="comment">#spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column=user_id</span></span><br><span class="line"><span class="comment">#spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression=m$-&gt;&#123;user_id % 2 + 1&#125;</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.database-strategy.inline.sharding-column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.database-strategy.inline.algorithm-expression</span>=<span class="string">m$-&gt;&#123;user_id % 2 + 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开sql输出日志</span></span><br><span class="line"><span class="meta">spring.shardingsphere.props.sql.show</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个实体类对应两张表，覆盖</span></span><br><span class="line"><span class="meta">spring.main.allow-bean-definition-overriding</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 Udict 实体类和 mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(value = <span class="string">"t_udict"</span>) <span class="comment">// 指定对应表名</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Udict</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long dictid;</span><br><span class="line">    <span class="keyword">private</span> String ustatus;</span><br><span class="line">    <span class="keyword">private</span> String uvalue;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UdictMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Udict</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UdictMapper udictMapper;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 添加操作</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDict</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Udict udict = <span class="keyword">new</span> Udict();</span><br><span class="line">       udict.setUstatus(<span class="string">"a"</span>);</span><br><span class="line">       udict.setUvalue(<span class="string">"已启用"</span>);</span><br><span class="line">       udictMapper.insert(udict);</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 删除操作</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteDict</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       QueryWrapper&lt;Udict&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">       <span class="comment">//设置 dictid 值</span></span><br><span class="line">       wrapper.eq(<span class="string">"dictid"</span>,<span class="number">573832604701163521L</span>);</span><br><span class="line">       udictMapper.delete(wrapper);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="2-6-实现读写分离"><a href="#2-6-实现读写分离" class="headerlink" title="2.6 实现读写分离"></a>2.6 实现读写分离</h3><ul>
<li><p>基本概念</p>
<p>为了确保数据库产品的稳定性，很多数据库拥有双机热备功能。也就是，第一台数据库服务器，是对外提供增删改业务的生产服务器；第二台数据库服务器，主要进行读的操作。<br><strong>原理：让主数据库（master）处理事务性增、删、改操作，而从数据库（slave）处理 SELECT 查询操作。</strong></p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/017.png" alt=""></p>
</li>
</ul>
<p>  主从复制：当主服务器有写入（insert/update/delete）语句时候，从服务器自动获取<br>  读写分离： insert/update/delete 语句操作一台服务器， select 操作另一个服务器</p>
<p>  <img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/018.png" alt=""></p>
<p>  <strong>Sharding-JDBC读写分离则是根据 SQL语义的分析，将读操作和写操作分别路由至主库与从库。</strong>它提供透明化读写分离，让使用方尽量像使用一个数据库一样使用主从数据库集群。</p>
<p>  <img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/019.png" alt=""></p>
<p>  Sharding-JDBC提供一主多从的读写分离配置，可独立使用，也可配合分库分表使用，<strong>同一线程且同一数据库连接内，如有写入操作，以后的读操作均从主库读取，用于保证数据一致性</strong>。</p>
<p>  <strong>Sharding-JDBC不提供主从数据库的数据同步功能</strong>，需要采用其他机制支持。</p>
<p>  <img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/020.png" alt=""></p>
<ul>
<li><p>MySQL 配置主从复制</p>
<p><strong>（一）创建两个 MySQL  数据库服务，并且启动两个 MySQL  服务</strong></p>
<p>（1）复制之前 MySQL 目录</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/021.png" alt=""></p>
<p>（2）修改复制之后配置文件</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/022.png" alt=""></p>
<p>⚫ 修改端口号，文件路径<br>⚫ 需要把数据文件目录(ProgramData)再复制一份</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/023.png" alt=""></p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/024.png" alt=""></p>
<p>（3）把复制修改之后的从数据库在 windows 安装服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld install mysqls1 --defaults-file="D:\Program Files\MySQL\MySQL Server-s1\my.ini"</span><br></pre></td></tr></table></figure>

<p>删除服务命令（如果需要）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc delete 服务名称</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/025.png" alt=""></p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/026.png" alt=""></p>
</li>
</ul>
<p>  <strong>（二）配置 MySQL 主从服务器</strong></p>
<p>  （1）在主服务器配置文件 my.ini</p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment">#开启日志</span></span><br><span class="line"><span class="meta">log‐bin</span> = <span class="string">mysql‐bin</span></span><br><span class="line"><span class="comment">#设置服务id，主从不能一致</span></span><br><span class="line"><span class="meta">server‐id</span> = <span class="string">1</span></span><br><span class="line"><span class="comment">#设置需要同步的数据库</span></span><br><span class="line"><span class="meta">binlog‐do‐db</span>=<span class="string">user_db</span></span><br><span class="line"><span class="comment">#屏蔽系统库同步</span></span><br><span class="line"><span class="meta">binlog‐ignore‐db</span>=<span class="string">mysql</span></span><br><span class="line"><span class="meta">binlog‐ignore‐db</span>=<span class="string">information_schema</span></span><br><span class="line"><span class="meta">binlog‐ignore‐db</span>=<span class="string">performance_schema</span></span><br></pre></td></tr></table></figure>

<p>  （2）在从服务器配置文件 my.ini</p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment">#开启日志</span></span><br><span class="line"><span class="meta">log‐bin</span> = <span class="string">mysql‐bin</span></span><br><span class="line"><span class="comment">#设置服务id，主从不能一致</span></span><br><span class="line"><span class="meta">server‐id</span> = <span class="string">2</span></span><br><span class="line"><span class="comment">#设置需要同步的数据库</span></span><br><span class="line"><span class="attr">replicate_wild_do_table</span>=<span class="string">user_db.%</span></span><br><span class="line"><span class="comment">#屏蔽系统库同步</span></span><br><span class="line"><span class="attr">replicate_wild_ignore_table</span>=<span class="string">mysql.%</span></span><br><span class="line"><span class="attr">replicate_wild_ignore_table</span>=<span class="string">information_schema.%</span></span><br><span class="line"><span class="attr">replicate_wild_ignore_table</span>=<span class="string">performance_schema.%</span></span><br></pre></td></tr></table></figure>

<p>  （3）重启主、从服务器</p>
<p>  <strong>（三）创建用于主从复制的账号</strong></p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#切换至主库bin目录，登录主库</span></span><br><span class="line">mysql ‐h localhost ‐uroot ‐p</span><br><span class="line"><span class="comment">#授权主备复制专用账号</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'db_sync'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'db_sync'</span>;</span><br><span class="line"><span class="comment">#刷新权限</span></span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure>

<p>  <img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/027.png" alt=""></p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#确认位点 记录下文件名以及位点</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">status</span>;</span><br></pre></td></tr></table></figure>

<p>  <img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/028.png" alt=""></p>
<p>  <strong>（四）主从数据同步设置</strong></p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#切换至从库bin目录，登录从库</span></span><br><span class="line">mysql ‐h localhost ‐P3307 ‐uroot ‐p</span><br><span class="line"><span class="comment">#先停止同步</span></span><br><span class="line"><span class="keyword">STOP</span> <span class="keyword">SLAVE</span>;</span><br><span class="line"><span class="comment">#修改从库指向到主库，使用上一步记录的文件名以及位点</span></span><br><span class="line"><span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span></span><br><span class="line">master_host = <span class="string">'localhost'</span>,</span><br><span class="line">master_user = <span class="string">'db_sync'</span>,</span><br><span class="line">master_password = <span class="string">'db_sync'</span>,</span><br><span class="line">master_log_file = <span class="string">'mysql-bin.000177'</span>,</span><br><span class="line">master_log_pos = <span class="number">107</span>;</span><br><span class="line"><span class="comment">#启动同步</span></span><br><span class="line"><span class="keyword">START</span> <span class="keyword">SLAVE</span>;</span><br><span class="line"><span class="comment">#查看Slave_IO_Runing和Slave_SQL_Runing字段值都为Yes，表示同步配置成功。如果不为Yes，请排查相关异常，可以查看Last_Error等字段。</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span></span><br></pre></td></tr></table></figure>

<p>  <img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/029.png" alt=""></p>
<p>  如果之前此从库已有主库指向 需要先执行以下命令清空：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">STOP</span> <span class="keyword">SLAVE</span> IO_THREAD <span class="keyword">FOR</span> CHANNEL <span class="string">''</span>;</span><br><span class="line"><span class="keyword">reset</span> <span class="keyword">slave</span> <span class="keyword">all</span>;</span><br></pre></td></tr></table></figure>



<ul>
<li><p>Sharding-JDBC  操作</p>
<p>（1）配置读写分离策略</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sharding-jdbc 分片策略</span></span><br><span class="line"><span class="comment"># 配置数据源，给数据源起名</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.names</span>=<span class="string">m1,m2,m0,s0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m1具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.url</span>=<span class="string">jdbc:mysql://localhost:3306/edu_db_1?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m1.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m2具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.url</span>=<span class="string">jdbc:mysql://localhost:3306/edu_db_2?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m2.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m0具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="comment"># user_db主服务器</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.url</span>=<span class="string">jdbc:mysql://localhost:3306/user_db?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.m0.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据源m0具体内容，包含连接池、驱动、地址、用户名和密码</span></span><br><span class="line"><span class="comment"># user_db从服务器</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.s0.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.s0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.s0.url</span>=<span class="string">jdbc:mysql://localhost:3308/user_db?serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.s0.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.shardingsphere.datasource.s0.password</span>=<span class="string">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主库从库逻辑数据源定义 ds0 为 user_db</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.master-slave-rules.ds0.master-data-source-name</span>=<span class="string">m0</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.master-slave-rules.ds0.slave-data-source-names</span>=<span class="string">s0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置user_db数据库里面t_user专库专表</span></span><br><span class="line"><span class="comment">#spring.shardingsphere.sharding.tables.t_user.actual-data-nodes=m$-&gt;&#123;0&#125;.t_user</span></span><br><span class="line"><span class="comment"># t_user 分表策略，固定分配至 ds0 的 t_user 真实表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.actual-data-nodes</span>=<span class="string">ds0.t_user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置公共表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.broadcast-tables</span>=<span class="string">t_udict</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_udict.key-generator.column</span>=<span class="string">dictid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_udict.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定t_user表的主键cid生成策略 SNOWFLAKE</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.key-generator.column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># t_user表不分片</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.table-strategy.inline.sharding-column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.t_user.table-strategy.inline.algorithm-expression</span>=<span class="string">t_user</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库分布情况、数据库里面表分布情况</span></span><br><span class="line"><span class="comment"># m1、m2  course_1、course_2</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.actual-data-nodes</span>=<span class="string">m$-&gt;&#123;1..2&#125;.course_$-&gt;&#123;1..2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定course表的主键cid生成策略 SNOWFLAKE</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.key-generator.type</span>=<span class="string">SNOWFLAKE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定表分片策略 约定cid值偶数添加到course_1表，如果cid是奇数添加到course_2表</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.sharding-column</span>=<span class="string">cid</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.table-strategy.inline.algorithm-expression</span>=<span class="string">course_$-&gt;&#123;cid % 2 + 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定数据库分片策略 约定 user_id 是偶数添加到 m1，是奇数添加到 m2</span></span><br><span class="line"><span class="comment">#spring.shardingsphere.sharding.default-database-strategy.inline.sharding-column=user_id</span></span><br><span class="line"><span class="comment">#spring.shardingsphere.sharding.default-database-strategy.inline.algorithm-expression=m$-&gt;&#123;user_id % 2 + 1&#125;</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.database-strategy.inline.sharding-column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">spring.shardingsphere.sharding.tables.course.database-strategy.inline.algorithm-expression</span>=<span class="string">m$-&gt;&#123;user_id % 2 + 1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开sql输出日志</span></span><br><span class="line"><span class="meta">spring.shardingsphere.props.sql.show</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一个实体类对应两张表，覆盖</span></span><br><span class="line"><span class="meta">spring.main.allow-bean-definition-overriding</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>（2）编写测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加操作</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUserDb2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       User user = <span class="keyword">new</span> User();</span><br><span class="line">       user.setUsername(<span class="string">"lucymary"</span>);</span><br><span class="line">       user.setUstatus(<span class="string">"a"</span>);</span><br><span class="line">       userMapper.insert(user);</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 查询操作</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUserDb2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">       <span class="comment">// 设置 userid 值</span></span><br><span class="line">       wrapper.eq(<span class="string">"user_id"</span>,<span class="number">574158941240426497L</span>);</span><br><span class="line">       User user = userMapper.selectOne(wrapper);</span><br><span class="line">       System.out.println(user);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="3-Sharding-Proxy"><a href="#3-Sharding-Proxy" class="headerlink" title="3.Sharding-Proxy"></a>3.Sharding-Proxy</h2><h3 id="3-1-简介"><a href="#3-1-简介" class="headerlink" title="3.1 简介"></a>3.1 简介</h3><p>Sharding-Proxy 是 ShardingSphere 的第二个产品。它<strong>定位为透明化的数据库代理端</strong>，提供封装了数据库二进制协议的服务端版本，用于完成对异构语言的支持。 目前先提供 MySQL/PostgreSQL 版本，它可以使用任何兼容 MySQL/PostgreSQL 协议的访问客户端(如：MySQL Command Client, MySQL Workbench, Navicat 等)操作数据，对 DBA 更加友好。</p>
<ul>
<li>向应用程序完全透明，可直接当做 MySQL/PostgreSQL 使用</li>
<li>适用于任何兼容 MySQL/PostgreSQL 协议的的客户端</li>
</ul>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/030.png" alt=""></p>
<h3 id="3-2-安装"><a href="#3-2-安装" class="headerlink" title="3.2 安装"></a>3.2 安装</h3><p>Sharding-Proxy 独立应用， 需要安装服务，进行分库分表或者读写分离配置，启动使用。</p>
<p>（1）下载安装软件</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/031.png" alt=""></p>
<p>（2）把下载之后压缩文件，解压，启动 bin 目录启动文件就可以了</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/032.png" alt=""></p>
<h3 id="3-3-Sharding-Proxy配置-分表"><a href="#3-3-Sharding-Proxy配置-分表" class="headerlink" title="3.3 Sharding-Proxy配置(分表)"></a>3.3 Sharding-Proxy配置(分表)</h3><ul>
<li><p>进入 conf  目录，修改文件 server.yaml ，打开两段内容注释</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/033.png" alt=""></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">authentication:</span></span><br><span class="line">  <span class="attr">users:</span></span><br><span class="line">    <span class="attr">root:</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">sharding:</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">sharding</span> </span><br><span class="line">      <span class="attr">authorizedSchemas:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">props:</span></span><br><span class="line">  <span class="attr">max.connections.size.per.query:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">acceptor.size:</span> <span class="number">16</span>  <span class="comment"># The default value is available processors count * 2.</span></span><br><span class="line">  <span class="attr">executor.size:</span> <span class="number">16</span>  <span class="comment"># Infinite by default.</span></span><br><span class="line">  <span class="attr">proxy.frontend.flush.threshold:</span> <span class="number">128</span>  <span class="comment"># The default value is 128.</span></span><br><span class="line">    <span class="comment"># LOCAL: Proxy will run with LOCAL transaction.</span></span><br><span class="line">    <span class="comment"># XA: Proxy will run with XA transaction.</span></span><br><span class="line">    <span class="comment"># BASE: Proxy will run with B.A.S.E transaction.</span></span><br><span class="line">  <span class="attr">proxy.transaction.type:</span> <span class="string">LOCAL</span></span><br><span class="line">  <span class="attr">proxy.opentracing.enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">query.with.cipher.column:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sql.show:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>进入 conf  目录，修改 config-sharding.yaml</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/034.png" alt=""></p>
<p>（1）复制 mysql 驱动 jar 包到 lib 目录</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/035.png" alt=""></p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/036.png" alt=""></p>
<p>（2）配置分库分表规则</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="attr">ds_0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/edu_1?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">shardingRule:</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">ds_$&#123;0&#125;.t_order_$&#123;0..1&#125;</span></span><br><span class="line">      <span class="attr">tableStrategy:</span></span><br><span class="line">        <span class="attr">inline:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">order_id</span></span><br><span class="line">          <span class="attr">algorithmExpression:</span> <span class="string">t_order_$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line">      <span class="attr">keyGenerator:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">SNOWFLAKE</span></span><br><span class="line">        <span class="attr">column:</span> <span class="string">order_id</span></span><br><span class="line">  <span class="attr">bindingTables:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">t_order</span></span><br><span class="line">  <span class="attr">defaultDatabaseStrategy:</span></span><br><span class="line">    <span class="attr">inline:</span></span><br><span class="line">      <span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">      <span class="attr">algorithmExpression:</span> <span class="string">ds_$&#123;0&#125;</span></span><br><span class="line">  <span class="attr">defaultTableStrategy:</span></span><br><span class="line">    <span class="attr">none:</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 Sharding-Proxy  服务</p>
<p>（1）Sharding-Proxy 默认端口号 3307</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/037.png" alt=""></p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/038.png" alt=""></p>
</li>
<li><p>通过 Sharding-Proxy  启动端口进行连接</p>
<p>（1）打开 cmd 窗口连接 Sharding-Proxy，连接方式和连接 mysql 一样</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/039.png" alt=""></p>
<p>（2）进行 sql 命令操作看到只有一个库</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/040.png" alt=""></p>
<p>（3）在 sharding_db 数据库创建表</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/041.png" alt=""></p>
<p>（4）向表添加一条记录</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/042.png" alt=""></p>
</li>
<li><p>回到本地 3306 端口实际数据库中，看到已经创建好了表和添加数据</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/043.png" alt=""></p>
</li>
</ul>
<h3 id="3-4-Sharding-Proxy配置-分库"><a href="#3-4-Sharding-Proxy配置-分库" class="headerlink" title="3.4 Sharding-Proxy配置(分库)"></a>3.4 Sharding-Proxy配置(分库)</h3><ul>
<li><p>创建两个数据库</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/044.png" alt=""></p>
</li>
<li><p>配置 config-sharding.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schemaName:</span> <span class="string">sharding_db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="attr">ds_0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/edu_db_1?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">ds_1:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/edu_db_2?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">shardingRule:</span></span><br><span class="line">  <span class="attr">tables:</span></span><br><span class="line">    <span class="attr">t_order:</span></span><br><span class="line">      <span class="attr">actualDataNodes:</span> <span class="string">ds_$&#123;0..1&#125;.t_order_$&#123;1..2&#125;</span></span><br><span class="line">      <span class="attr">tableStrategy:</span></span><br><span class="line">        <span class="attr">inline:</span></span><br><span class="line">          <span class="attr">shardingColumn:</span> <span class="string">order_id</span></span><br><span class="line">          <span class="attr">algorithmExpression:</span> <span class="string">t_order_$&#123;order_id</span> <span class="string">%</span> <span class="number">2</span> <span class="string">+</span> <span class="number">1</span><span class="string">&#125;</span></span><br><span class="line">      <span class="attr">keyGenerator:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">SNOWFLAKE</span></span><br><span class="line">        <span class="attr">column:</span> <span class="string">order_id</span></span><br><span class="line">  <span class="attr">bindingTables:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">t_order</span></span><br><span class="line">  <span class="attr">defaultDatabaseStrategy:</span></span><br><span class="line">    <span class="attr">inline:</span></span><br><span class="line">      <span class="attr">shardingColumn:</span> <span class="string">user_id</span></span><br><span class="line">      <span class="attr">algorithmExpression:</span> <span class="string">ds_$&#123;user_id</span> <span class="string">%</span> <span class="number">2</span><span class="string">&#125;</span></span><br><span class="line">  <span class="attr">defaultTableStrategy:</span></span><br><span class="line">    <span class="attr">none:</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 Sharding-Proxy 服务</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/045.png" alt=""></p>
</li>
<li><p>打开 cmd 仓库，连接 Sharding-Proxy 服务</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/046.png" alt=""></p>
<p>（1）创建数据库表，向表添加记录</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/047.png" alt=""></p>
<p>（2）连接本地 3306 的 MySql 数据库服务器，表已经创建出来，表里面有数据</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/048.png" alt=""></p>
</li>
</ul>
<h3 id="3-5-Sharding-Proxy配置-读写分离"><a href="#3-5-Sharding-Proxy配置-读写分离" class="headerlink" title="3.5 Sharding-Proxy配置(读写分离)"></a>3.5 Sharding-Proxy配置(读写分离)</h3><ul>
<li><p>创建三个数据库</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/049.png" alt=""></p>
</li>
<li><p>配置 conf 目录的 config-master-slave.yaml</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/050.png" alt=""></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">schemaName:</span> <span class="string">master_slave_db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="attr">master_ds:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/demo_ds_master?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">slave_ds_0:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/demo_ds_slave_0?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">slave_ds_1:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/demo_ds_slave_1?serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">connectionTimeoutMilliseconds:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">idleTimeoutMilliseconds:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">maxLifetimeMilliseconds:</span> <span class="number">1800000</span></span><br><span class="line">    <span class="attr">maxPoolSize:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line"><span class="attr">masterSlaveRule:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ms_ds</span></span><br><span class="line">  <span class="attr">masterDataSourceName:</span> <span class="string">master_ds</span></span><br><span class="line">  <span class="attr">slaveDataSourceNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">slave_ds_0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">slave_ds_1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 Sharding-Proxy  服务</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/051.png" alt=""></p>
</li>
<li><p>通过 cmd  连接 Sharding-Proxy ，进行创建表和添加记录操作</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/052.png" alt=""></p>
<p>（1）在主数据库和从数据库里面，都创建数据库表</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/053.png" alt=""></p>
<p>（2）向表添加记录，不指定向哪个库添加（实际结果：添加到主库 demo_ds_master）</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/054.png" alt=""></p>
<p>（3）查询数据库表数据，不指定查询哪个库（实际结果：查询的可能是从库 demo_ds_slave_0 或 demo_ds_slave_1）</p>
<p>向 2 个从库分别添加 1 条数据：</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/055.png" alt=""></p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/056.png" alt=""></p>
<p>查询结果：</p>
<p><img src="https://gitee.com/sunshine-zwq/blog-pic/raw/master/blogPics/2021/0302/057.png" alt=""></p>
</li>
</ul>
</div><div class="post-copyright"><blockquote><p>原文作者: zwq</p><p>原文链接: <a href="https://sunshine-zwq.gitee.io/2021/03/04/ShardingSphere学习/">https://sunshine-zwq.gitee.io/2021/03/04/ShardingSphere学习/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/ShardingSphere/">ShardingSphere</a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">分库分表</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2021/03/15/Dubbo%E5%85%A5%E9%97%A8/" class="pre">Dubbo入门</a><a href="/2021/02/24/Linux%E5%AD%A6%E4%B9%A0-Shell%E7%BC%96%E7%A8%8B/" class="next">Linux学习-Shell编程</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-基本概念"><span class="toc-text">1.基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-什么是-Sharding-Sphere"><span class="toc-text">1.1 什么是 Sharding Sphere</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-什么是分库分表"><span class="toc-text">1.2 什么是分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-分库分表的方式"><span class="toc-text">1.2.1 分库分表的方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-垂直切分"><span class="toc-text">1.2.2 垂直切分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-水平切分"><span class="toc-text">1.2.3 水平切分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-4-分库分表应用及问题"><span class="toc-text">1.2.4 分库分表应用及问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Sharding-JDBC"><span class="toc-text">2.Sharding-JDBC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-简介"><span class="toc-text">2.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-实现水平分表"><span class="toc-text">2.2 实现水平分表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-实现水平分库"><span class="toc-text">2.3 实现水平分库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-实现垂直分库"><span class="toc-text">2.4 实现垂直分库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-操作公共表"><span class="toc-text">2.5 操作公共表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-实现读写分离"><span class="toc-text">2.6 实现读写分离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Sharding-Proxy"><span class="toc-text">3.Sharding-Proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-简介"><span class="toc-text">3.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-安装"><span class="toc-text">3.2 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Sharding-Proxy配置-分表"><span class="toc-text">3.3 Sharding-Proxy配置(分表)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-Sharding-Proxy配置-分库"><span class="toc-text">3.4 Sharding-Proxy配置(分库)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-Sharding-Proxy配置-读写分离"><span class="toc-text">3.5 Sharding-Proxy配置(读写分离)</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/03/15/Dubbo%E5%85%A5%E9%97%A8/">Dubbo入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/04/ShardingSphere%E5%AD%A6%E4%B9%A0/">ShardingSphere学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/24/Linux%E5%AD%A6%E4%B9%A0-Shell%E7%BC%96%E7%A8%8B/">Linux学习-Shell编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/07/Linux%E5%AD%A6%E4%B9%A0-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85-MySQL/">Linux学习-环境安装-MySQL</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/07/Linux%E5%AD%A6%E4%B9%A0-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85-Eclipse/">Linux学习-环境安装-Eclipse</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/07/Linux%E5%AD%A6%E4%B9%A0-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85-Tomcat/">Linux学习-环境安装-Tomcat</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/05/Linux%E5%AD%A6%E4%B9%A0-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85-JDK/">Linux学习-环境安装-JDK</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/05/Linux%E5%AD%A6%E4%B9%A0-RPM%E4%B8%8EYUM/">Linux学习-RPM与YUM</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/05/Linux%E5%AD%A6%E4%B9%A0-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E6%9C%8D%E5%8A%A1/">Linux学习-进程与服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/04/Linux%E5%AD%A6%E4%B9%A0-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/">Linux学习-网络配置</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Dubbo/">Dubbo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">Java并发编程</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue-js/">Vue.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ftp/">ftp</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/js%E6%A8%A1%E5%9D%97%E5%8C%96/" style="font-size: 15px;">js模块化</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a> <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">并发编程</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/gitee/" style="font-size: 15px;">gitee</a> <a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/element-ui/" style="font-size: 15px;">element-ui</a> <a href="/tags/json/" style="font-size: 15px;">json</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 15px;">前端</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/jdk/" style="font-size: 15px;">jdk</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 15px;">面试</a> <a href="/tags/ftp/" style="font-size: 15px;">ftp</a> <a href="/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 15px;">正则表达式</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">工具</a> <a href="/tags/ECMAScript/" style="font-size: 15px;">ECMAScript</a> <a href="/tags/Dubbo/" style="font-size: 15px;">Dubbo</a> <a href="/tags/java8/" style="font-size: 15px;">java8</a> <a href="/tags/Lambda/" style="font-size: 15px;">Lambda</a> <a href="/tags/Stream/" style="font-size: 15px;">Stream</a> <a href="/tags/ShardingSphere/" style="font-size: 15px;">ShardingSphere</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 15px;">数据库</a> <a href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" style="font-size: 15px;">分库分表</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://github.com/sunshine-zwq" title="我的Github" target="_blank">我的Github</a><ul></ul><a href="https://blog.csdn.net/zwq1105" title="我的CSDN博客" target="_blank">我的CSDN博客</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">zwq.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>